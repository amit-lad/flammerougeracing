---
title: "Flamme Rouge"
output: 
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bootswatch: default
      navbar-bg: "#101010"
    logo: www/ART-navbar.png
    orientation: rows
    vertical_layout: fill
    self_contained: false
---



```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(here)
library(knitr)
library(lubridate)
library(DT)

load(here("data", "s3_tour_france", "data.RData"))

```

```{r}
riders_ART <- rider_list |> filter(Club == "ART")

total_racing_riders <- riders_ART |> filter(Tour_races > 0) |> nrow()
total_races <- sum(riders_ART$Tour_races)

current_position <- race_league |> filter(Team == "ART") |> select(Position) |> sum()

total_riders_by_category <- rider_list |>
  filter(Tour_races > 0) |>
  group_by(FRHC, Gender) |>
  summarise(count = n(), .by = NULL, .groups = "drop") |>
  pivot_wider(names_from = FRHC, values_from = count, values_fill = 0) |>
  mutate(Team = "ALL teams") |>
  select(Team, Gender, CAP, DRA, CRP, GHT, HAB, BON, CAY, JLP, PEP) |>
  arrange(desc(Gender)) |>
  filter(Gender %in% c("M", "F"))


riders_by_category <- riders_ART |>
  filter(Tour_races > 0) |>
  group_by(FRHC, Gender) |>
  summarise(count = n(), .by = NULL, .groups = "drop") |>
  add_row(FRHC = "CAP", Gender = "M", count = 0) |>
  add_row(FRHC = "DRA", Gender = "M", count = 0) |>
  add_row(FRHC = "CRP", Gender = "M", count = 0) |>
  add_row(FRHC = "GHT", Gender = "M", count = 0) |>
  add_row(FRHC = "HAB", Gender = "M", count = 0) |>
  add_row(FRHC = "BON", Gender = "M", count = 0) |>
  add_row(FRHC = "CAY", Gender = "M", count = 0) |>
  add_row(FRHC = "JLP", Gender = "M", count = 0) |>
  add_row(FRHC = "PEP", Gender = "M", count = 0) |>
  group_by(FRHC, Gender) |>
  summarise(count = n(), .by = NULL, .groups = "drop") |>
  pivot_wider(names_from = FRHC, values_from = count, values_fill = 0) |>
  mutate(Team = "ART only") |>
  select(Team, Gender, CAP, DRA, CRP, GHT, HAB, BON, CAY, JLP, PEP) |>
  arrange(desc(Gender))

riders_comparison_summary <-
  bind_rows(riders_by_category, total_riders_by_category)

ART_rider_table <-
  GC_jersey |>
  mutate( art_rider = str_detect(Rider, "\\[ART\\]$")) |>
  filter(art_rider == TRUE) |>
  mutate(Time = parse_time(Time, "%H:%M:%S")) |>
  select(Rider, category, gender, Stages, Time)

total_time_raced <- sum(ART_rider_table$Time) |>  as.period(unit = "%H:%M:%S")

ART_riders_stage_breakdown <-
  all_stage_performance |>
  mutate( art_rider = str_detect(Rider, "\\[ART\\]$")) |>
  filter(art_rider == TRUE)

ART_league_results <-
  team_stage_result |>
  filter(is.na(`Team league points`) == FALSE) |>
  mutate(art_rider = str_detect(Rider, "^ART")) |>
  filter(art_rider == TRUE)

team_stage_summary <-
  team_stage_result |>
  filter(is.na(`Team league points`) == FALSE) |>
  mutate(
    team = str_extract(Rider, "^[:alpha:]+"),
    stage_num = as.integer(str_extract(Stage, "[:digit:]+"))
  ) |>
  mutate(art_team = str_detect(Rider, "^ART")) |>
  group_by(team)|>
  mutate(
    cumulative_points_raw = cumsum(`Team points raw`),
    cumulative_league_points = cumsum(`Team league points`),
    art_cumulative_points_raw = case_when(art_team == TRUE ~ cumulative_points_raw, TRUE ~ NA),
    art_cumulative_league_points = case_when(art_team == TRUE ~ cumulative_league_points, TRUE ~ NA)
  )
  
  

```



Summary statistics
======================

> Tour series 3 - Tour France - Last updated: `last_updated` 

### team position
```{r}
valueBox(current_position, icon = "fa-ranking-star")
```

### riders have raced
```{r}
valueBox(total_racing_riders, icon = "fa-people-group")
```

### stages raced
```{r}
valueBox(total_races, icon = "fa-person-biking")
```

### time spent racing
```{r}
valueBox(total_time_raced, icon = "fa-stopwatch")
```

Team riders
======================

### ART riders
```{r}
ART_rider_table |>
  DT::datatable(style = "auto")
```


Participation stats
======================

### How many ART riders rode each stage?
```{r}
ART_riders_by_stage <-
  ART_riders_stage_breakdown |>
  group_by(Stage) |>
  summarise(num_riders = n(), .groups = "drop")

ART_riders_by_stage |>
  ggplot(mapping = aes(x = Stage, y = num_riders)) +
  theme_linedraw() +
  geom_col() +
  geom_text(aes(label = num_riders), vjust = 1.5, colour = "white")
```

### How many stages has each ART rider ridden?
```{r}
ART_riders_total_stages <-
  ART_rider_table |>
  group_by(Stages) |>
  summarise(num_riders = n(), .groups = "drop")
  
ART_riders_total_stages |>
  ggplot(mapping = aes(x = Stages, y = num_riders)) +
  theme_linedraw() +
  geom_col() +
  geom_text(aes(label = num_riders), vjust = 1.5, colour = "white")
```


Performance stats
======================

Row
------------------------

### How many raw points has ART earned each stage?
```{r}
ART_league_results |>
  ggplot(mapping = aes(x = Stage, y = `Team points raw`)) +
  theme_linedraw() +
  geom_col() +
  geom_text(aes(label = `Team points raw`), vjust = 1.5, colour = "white")
```

### How many league points has ART earned each stage? (Max 50)
```{r}
ART_league_results |>
  ggplot(mapping = aes(x = Stage, y = `Team league points`)) +
  theme_linedraw() +
  geom_col() +
  geom_text(aes(label = `Team league points`), vjust = 1.5, colour = "white")
```

Row
------------------------

### ART cumulative raw points vs other teams
```{r}
team_stage_summary |>
  ggplot(mapping = aes(x = Stage, y = cumulative_points_raw, group = team)) +
  theme_linedraw() +
  geom_line(color = "grey90")+
  geom_line(mapping = aes(x = Stage, y = art_cumulative_points_raw, group = team))

```

### ART cumulative league points vs other teams
```{r}
team_stage_summary |>
  ggplot(mapping = aes(x = Stage, y = cumulative_league_points, group = team)) +
  theme_linedraw() +
  geom_line(color = "grey90")+
  geom_line(mapping = aes(x = Stage, y = art_cumulative_league_points, group = team))
```


